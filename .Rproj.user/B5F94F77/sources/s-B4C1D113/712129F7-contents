library(tidyverse)
library(psycho)


# Stereotypes -------------------------------------------------------------


stereo <- read.csv("df_fiction.csv") %>%
    dplyr::select(Participant_ID,
                Fiction_Q3_Stererotypes_Negative,
                Fiction_Q4_Stererotypes_Negative,
                Fiction_Q5_Stererotypes_Positive,
                Fiction_Q6_Stererotypes_Positive) %>%
  dplyr::group_by(Participant_ID) %>%
  dplyr::summarise_all(mean)


results <- psycho::n_factors(dplyr::select(stereo, -Participant_ID), rotate="oblimin", fm="pc")
# plot(results)
# summary(results)
# values(results)$methods

# PCA 2 FACTEUR
pca <- psych::pca(qgraph::cor_auto(dplyr::select(stereo, -Participant_ID)),
                        nfactors = 2,
                        n.obs=nrow(stereo),
                        rotate="oblimin")

# print(pca$loadings,
#       digits = 2,
#       cutoff = 0,
#       sort = T)

latent_outcomes <- as.data.frame(predict(pca, dplyr::select(stereo, -Participant_ID)))
names(latent_outcomes) <- c("Fiction_Stererotypes_Negative", "Fiction_Stererotypes_Positive")
stereo_final <- cbind(dplyr::select(stereo, Participant_ID), latent_outcomes)


# PCA 1 FACTEUR
pca <- psych::pca(qgraph::cor_auto(dplyr::select(stereo, -Participant_ID)),
                  nfactors = 1,
                  n.obs=nrow(stereo),
                  rotate="oblimin")
# pca$loadings
# print(pca$loadings,
#       digits = 2,
#       cutoff = 0,
#       sort = T)

latent_outcomes <- as.data.frame(predict(pca, dplyr::select(stereo, -Participant_ID)))
names(latent_outcomes) <- "Fiction_Stererotypes"
stereo <- cbind(stereo_final, latent_outcomes)



# Loading -----------------------------------------------------------------

df <- read.csv("df_fiction.csv") %>%
  filter(Condition!="Distractor") %>%
  mutate(Participant_Education=Participant_Current_Education_Level,
         Subjective_Condition=Condition_Believed_2,
         Subjective_Belief_Binary=Subjective_Belief_Dichotomous,
         Interoception_Sensibility=Interoception_Sensibility/100) %>%
  select(-Switch_Switching_Speed,
         -Fiction_Stererotypes_Negative,
         -Fiction_Stererotypes_Positive) %>%
  rename(Switch_Switching_Speed=Switch_Switching_Speed.1) %>%
  left_join(stereo, by="Participant_ID") %>%
  dplyr::select(Participant_ID,
                Participant_Age,
                Participant_Education,
                Emotion,
                Condition,
                Item,
                Order,
                Conceptual_Relevance,
                Subjective_Arousal=Z_Subjective_Arousal,
                Subjective_Valence=Z_Subjective_Valence,
                Subjective_Control=Z_Subjective_Control,
                Subjective_Belief_Dichotomous=Subjective_Belief_Dichotomous,
                SCR_Magnitude_Log,
                ECG_Heart_Rate_MinDiff,
                ERP_CP_400_700_TP9_det_mean,
                ERP_CP_500_800_TP9_det_mean,
                ERP_CP_550_800_TP9_det_mean,
                ERP_FC_300_500_TP9_det_mean,
                ERP_FC_350_550_TP9_det_mean,
                Resting_HRV_DFA_1,
                Resting_HRV_RMSSD,
                Interoception_Accuracy,
                Interoception_Sensibility,
                Interoception_Awareness,
                Interoception_Awareness_abs,
                ASQ_Adjusting,
                ASQ_Concealing,
                ASQ_Tolerating,
                Fiction_Stererotypes_Negative,
                Fiction_Stererotypes_Positive,
                Fiction_Stererotypes,
                Persona_Empathy,
                Switch_Switching_Speed,
                SimAct_Capacity_Span,
                SimAct_Updating_Span,
                CoCon_Inhibition,
                CoCon_Conflict,
                CoCon_Response,
                CoCon_Core_Speed,
                Subjective_Belief,
                Subjective_Belief_Certainty) %>%
  mutate(Order=as.factor(Order)) %>%
  psycho::standardize(except=c("Subjective_Belief", "Subjective_Belief_Certainty")) %>%
  mutate(Emotion = relevel(Emotion, ref="Negative"),
         Condition = relevel(Condition, ref="Reality"),
         Subjective_Control=-1*Subjective_Control,
         CoCon_Core_Speed=-1*CoCon_Core_Speed,
         CoCon_Response=-1*CoCon_Response,
         CoCon_Inhibition=-1*CoCon_Inhibition,
         CoCon_Conflict=-1*CoCon_Conflict,
         Switch_Switching_Speed=-1*Switch_Switching_Speed,
         Resting_HRV_DFA_1=-1*Resting_HRV_DFA_1,
         ECG_Heart_Rate_MinDiff=-1*ECG_Heart_Rate_MinDiff,
         Subjective_Valence=-1*Subjective_Valence) %>%
  filter(Subjective_Belief_Dichotomous == "Yes") %>%
  droplevels()






# df <- read.csv("df_fiction.csv") %>%
#   filter(Condition!="Distractor") %>%
#   mutate(Participant_Education=Participant_Current_Education_Level,
#          Subjective_Condition=Condition_Believed_2,
#          Subjective_Belief_Binary=Subjective_Belief_Dichotomous) %>%
#   mutate(Switch_Switching_Speed = (Switch_Speed_Switch-Switch_Speed_NoSwitch)/Switch_Speed_Switch) %>%
#   dplyr::select(
#     Participant_ID,
#     Emotion,
#     Condition,
#     Item,
#     Order,
#     Subjective_Arousal=Z_Subjective_Arousal,
#     Subjective_Valence=Z_Subjective_Valence,
#     Subjective_Control=Z_Subjective_Control,
#     SCR_Magnitude_Log,
#     ECG_Heart_Rate_MinDiff,
#     ERP_CP_400_700_TP9_det_mean,
#     ASQ_Adjusting,
#     ASQ_Concealing,
#     ASQ_Tolerating,
#     Persona_Social_Desirability,
#     Persona_Empathy,
#     Resting_HRV_RMSSD,
#     Resting_HRV_DFA_1,
#     Interoception_Accuracy,
#     Interoception_Sensitivity,
#     Interoception_Meta_Confidence_Pearson,
#     CoCon_Core_Speed,
#     CoCon_Inhibition,
#     CoCon_Conflict,
#     Switch_Switching_Speed,
#     Switch_Switching_Error,
#     SimAct_Capacity_Span,
#     SimAct_Updating_Span) %>%
#   mutate(Order=as.factor(Order)) %>%
#   psycho::normalize() %>%
#   mutate(Emotion = factor(Emotion, levels = c("Negative", "Neutral")),
#          Subjective_Control=-1*Subjective_Control,
#          CoCon_Core_Speed=-1*CoCon_Core_Speed,
#          CoCon_Inhibition=-1*CoCon_Inhibition,
#          CoCon_Conflict=-1*CoCon_Conflict,
#          Switch_Switching_Speed=-1*Switch_Switching_Speed,
#          Switch_Switching_Error=-1*Switch_Switching_Error,
#          Resting_HRV_DFA_1=-1*Resting_HRV_DFA_1,
#          ECG_Heart_Rate_MinDiff=-1*ECG_Heart_Rate_MinDiff,
#          Subjective_Valence=-1*Subjective_Valence) %>%
#   droplevels()
#
#
# # By Participants ------------------------------------------------------------
#
# dfsub <- read.csv("df_fiction.csv") %>%
#   filter(Condition!="Distractor") %>%
#   group_by(Participant_ID) %>%
#   summarise(Age=mean(Participant_Age),
#             Sex=Participant_Sex[1],
#             Education=mean(Participant_Current_Education_Level),
#
#             # Fiction
#             Anticonformism = mean(Anticonformism),
#             Belief = 1-Anticonformism,
#
#             # Stereotypes
#             # Fiction_Stererotypes_Negative=mean(Fiction_Stererotypes_Negative),
#             # Fiction_Stererotypes_Positive=mean(Fiction_Stererotypes_Positive),
#             Fiction_Q3_Stererotypes_Negative=mean(Fiction_Q3_Stererotypes_Negative),
#             Fiction_Q4_Stererotypes_Negative=mean(Fiction_Q4_Stererotypes_Negative),
#             Fiction_Q5_Stererotypes_Positive=mean(Fiction_Q5_Stererotypes_Positive),
#             Fiction_Q6_Stererotypes_Positive=mean(Fiction_Q6_Stererotypes_Positive),
#
#             # Cognitive
#             Switch_Switching_IES_log=mean(Switch_Switching_IES_log),
#
#             SimAct_Updating_Span=mean(SimAct_Updating_Span),
#             SimAct_Capacity_Span=mean(SimAct_Capacity_Span),
#
#             # Personality
#             ASQ_Adjusting=mean(ASQ_Adjusting),
#             ASQ_Concealing=mean(ASQ_Concealing),
#             ASQ_Tolerating=mean(ASQ_Tolerating),
#
#             Persona_Social_Desirability=mean(Persona_Social_Desirability),
#             Persona_Empathy=mean(Persona_Empathy),
#
#             Sixide_Depression=mean(Sixide_Depression),
#             Sixide_Anxiety=mean(Sixide_Anxiety),
#             Sixide_Suicide=mean(Sixide_Suicide),
#
#             Comments=Comments[1]
#             )
#
#
#
# stereo <- dfsub %>%
#   dplyr::select(Fiction_Q3_Stererotypes_Negative,
#                 Fiction_Q4_Stererotypes_Negative,
#                 Fiction_Q5_Stererotypes_Positive,
#                 Fiction_Q6_Stererotypes_Positive)
#
#
# results <- psycho::n_factors(stereo, rotate="oblimin", fm="pc")
# # plot(results)
# # summary(results)
# # values(results)$methods
#
# # PCA
# pca <- psych::pca(qgraph::cor_auto(stereo),
#                         nfactors = 2,
#                         n.obs=nrow(stereo),
#                         rotate="oblimin")
# print(pca$loadings,
#       digits = 2,
#       cutoff = 0,
#       sort = T)
#
# latent_outcomes <- as.data.frame(predict(pca, stereo))
# names(latent_outcomes) <- c("Fiction_Stererotypes_Negative", "Fiction_Stererotypes_Positive")
# dfsub <- cbind(dfsub, latent_outcomes)
#
# df <- dfsub %>%
#   dplyr::select(Participant_ID,
#          Fiction_Stererotypes_Negative,
#          Fiction_Stererotypes_Positive) %>%
#   left_join(df, by="Participant_ID")
#
